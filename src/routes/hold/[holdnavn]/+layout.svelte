<script lang="ts">
	import { goto } from '$app/navigation';
	import { downloadJson, exportClassToJson, removeClass } from '$lib/persistence.svelte';
	import { toaster } from '$lib/toaster-svelte';
	import { classNameUrlName } from '$lib/utils';
	import { Modal } from '@skeletonlabs/skeleton-svelte';
	import type { LayoutProps } from './$types';

	let { children, data }: LayoutProps = $props();

	let openState = $state(false);

	function modalClose() {
		openState = false;
	}

	function editClass() {
		const classUrlName = classNameUrlName(data.currentClass.name);
		goto(`/hold/${classUrlName}/rediger`);
	}

	function exportClass() {
		const filename = `dangrupper-export-${data.currentClass.name}-${(new Date().toLocaleString())}.json`;
		const json = exportClassToJson(data.currentClass.id);
		downloadJson(filename, json);
	}

	function deleteClass() {
		modalClose();
		console.log('Deleting class', data.currentClass.name);
		removeClass(data.currentClass)
			.then(() => {
				goto('/', { invalidateAll: true });
				toaster.success({
					description: `Slettede holdet ${data.currentClass.name}.`,
				});
			})
			.catch((error) => {
				console.error(error);
				toaster.error({
					title: 'Kunne ikke slette hold',
					description: `(Fejlbesked: ${error.message})`,
				});
			});
	}
</script>

<!-- Class bar -->
<div class="grid grid-cols-[1fr_auto]">
	<h2 class="h2">{data.currentClass.name}</h2>
	<span class="flex items-center gap-4">
		<button type="button" class="btn preset-filled-primary-500" onclick={editClass}>
			RedigÃ©r hold
		</button>
		<button type="button" class="btn preset-filled-primary-500" onclick={exportClass}>
			EksportÃ©r hold
		</button>
		<Modal
			open={openState}
			onOpenChange={(e) => (openState = e.open)}
			triggerBase="btn preset-filled-primary-500"
			contentBase="card bg-surface-100-900 p-4 space-y-4 shadow-xl max-w-screen-sm"
			backdropClasses="backdrop-blur-sm"
		>
			{#snippet trigger()}Slet hold{/snippet}
			{#snippet content()}
				<header class="flex justify-between">
					<h4 class="h4">Vil du slette holdet "{data.currentClass.name}"?</h4>
				</header>
				<article>
					<p class="opacity-60">
						Tip: Tag en backup, inden du sletter holdet ğŸ˜Š
					</p>
				</article>
				<footer class="flex justify-end gap-4">
					<button type="button" class="btn preset-tonal" onclick={modalClose}>AnnullÃ©r</button>
					<button type="button" class="btn preset-filled" onclick={deleteClass}>Slet hold</button>
				</footer>
			{/snippet}
		</Modal>
	</span>
</div>

<!-- : Add tabs for subpages (each with their own URL) -->
<!-- Maybe something like one of these: https://flowbite.com/docs/components/tabs/ -->
<!-- Or these: https://pagedone.io/docs/tabs -->

{@render children()}
